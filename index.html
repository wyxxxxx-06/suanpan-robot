<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å°å­¦ç®—æ•°æœºå™¨äºº - ç®—ç›˜æ¼”ç¤º</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #e8dfd0 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #5c4a3a; margin-bottom: 8px; font-size: 1.5rem; }
        .sub { color: #8b7355; font-size: 0.9rem; margin-bottom: 20px; }
        .input-row {
            display: flex; align-items: center; gap: 12px; margin-bottom: 24px;
        }
        .display-box {
            width: 180px; min-height: 44px; padding: 10px 16px; font-size: 1.4rem;
            border: 2px solid #c4a574; border-radius: 12px; text-align: center;
            background: #fff; color: #4a3728; font-weight: bold; letter-spacing: 2px;
            user-select: none;
        }

        /* ====== åº”ç”¨å†…é”®ç›˜ ====== */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%; max-width: 280px;
            margin-top: 20px;
        }
        .nk {
            padding: 14px 0; font-size: 1.3rem; font-weight: bold;
            border: none; border-radius: 12px; cursor: pointer;
            background: #f5f0e8; color: #4a3728;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background 0.1s, transform 0.08s;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .nk:active { transform: scale(0.95); background: #e8dfd0; }
        .nk-op { background: #e8b86d; color: #5c4a3a; }
        .nk-op:active { background: #d4a050; }
        .nk-del { background: #f0d0b0; color: #8b5a2b; font-size: 1.1rem; }
        .nk-del:active { background: #e0c0a0; }
        .nk-clear { background: #e74c3c; color: #fff; }
        .nk-clear:active { background: #c0392b; }
        .btn {
            padding: 12px 24px; font-size: 1rem; border: none; border-radius: 12px;
            background: #8b6914; color: #fff; cursor: pointer; font-weight: bold;
        }
        .btn:hover { background: #6d5210; }
        .btn:disabled { background: #aaa; cursor: not-allowed; }

        /* ====== ç®—ç›˜ ====== */
        .abacus-wrap {
            background: linear-gradient(165deg, #e8d5b5 0%, #d4bc8c 50%, #c9a95c 100%);
            padding: 18px 22px;
            border-radius: 14px;
            border: 4px solid #a08050;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.5), 0 8px 24px rgba(0,0,0,0.15);
            overflow-x: auto;
            max-width: 100%;
        }
        .abacus { display: flex; flex-direction: column; gap: 6px; }
        .abacus-row {
            position: relative;
            height: 38px;
        }
        /* æ¨ªæ† */
        .rod {
            position: absolute; left: 0; right: 0;
            height: 8px; top: 50%; margin-top: -4px;
            background: linear-gradient(180deg, #a08060 0%, #6b4e30 50%, #a08060 100%);
            border-radius: 4px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.15);
        }
        /* ç å­ */
        .bead {
            position: absolute;
            top: 50%; transform: translateY(-50%);
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.2), 2px 2px 4px rgba(255,255,255,0.4);
            transition: left 0.28s ease;
            z-index: 1;
        }
        .bead.flash { animation: bump 0.3s ease; }
        @keyframes bump {
            0%,100% { transform: translateY(-50%) scale(1); }
            50%     { transform: translateY(-50%) scale(1.18); }
        }
        .bead.c-red    { background: radial-gradient(circle at 35% 35%, #ff7b7b, #d32f2f); }
        .bead.c-blue   { background: radial-gradient(circle at 35% 35%, #64b5f6, #1976d2); }
        .bead.c-orange { background: radial-gradient(circle at 35% 35%, #ffb74d, #e65100); }
        .bead.c-green  { background: radial-gradient(circle at 35% 35%, #81c784, #2e7d32); }
        .bead.c-yellow { background: radial-gradient(circle at 35% 35%, #fff176, #f9a825); }

        /* åˆ†éš”çº¿ */
        .abacus-divider {
            height: 2px;
            background: rgba(0,0,0,0.15);
            margin: 4px 0;
            border-radius: 1px;
            display: none;
        }
        .abacus-divider.visible { display: block; }

        /* è¯´æ˜æ¡† */
        .explain {
            margin-top: 24px; width: 100%; max-width: 460px;
            min-height: 80px; padding: 16px 20px;
            background: #fffef9; border: 2px solid #c4a574;
            border-radius: 12px; font-size: 1rem; line-height: 1.8; color: #4a3728;
        }
        .explain .line { margin-bottom: 4px; }
        .explain .hl { color: #8b6914; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ§® å°å­¦ç®—æ•°æœºå™¨äºº</h1>
    <p class="sub">100 ä»¥å†…åŠ å‡ï¼Œç”¨ç®—ç›˜æ‹¨ç çœ‹è¿‡ç¨‹</p>

    <div class="input-row">
        <div class="display-box" id="display"></div>
        <button class="btn" id="go">æ‹¨ç æ¼”ç¤º</button>
    </div>
    <input type="text" id="expr" style="position:absolute;left:-9999px;" readonly>

    <div class="abacus-wrap">
        <div class="abacus" id="abacus"></div>
    </div>

    <div class="explain" id="explain">
        ç”¨ä¸‹é¢çš„é”®ç›˜è¾“å…¥ç®—å¼ï¼Œç‚¹ã€Œæ‹¨ç æ¼”ç¤ºã€å¼€å§‹ï¼
    </div>

    <div class="numpad" id="numpad">
        <button class="nk" data-val="1">1</button>
        <button class="nk" data-val="2">2</button>
        <button class="nk" data-val="3">3</button>
        <button class="nk" data-val="4">4</button>
        <button class="nk" data-val="5">5</button>
        <button class="nk" data-val="6">6</button>
        <button class="nk" data-val="7">7</button>
        <button class="nk" data-val="8">8</button>
        <button class="nk" data-val="9">9</button>
        <button class="nk nk-op" data-val="+">+</button>
        <button class="nk" data-val="0">0</button>
        <button class="nk nk-op" data-val="-">&minus;</button>
        <button class="nk nk-del" data-val="del">&#9003;</button>
        <button class="nk nk-clear" data-val="clear">C</button>
    </div>

<script>
const ROWS = 10, COLS = 10;
const ROW_COLORS = ['c-red','c-red','c-blue','c-blue','c-orange','c-orange','c-green','c-green','c-yellow','c-yellow'];

let rowStates = new Array(ROWS).fill(0);   // æ¯è¡Œå·²æ‹¨åˆ°å³è¾¹çš„ç å­æ•°
let SLOT = 24;   // ä¸€é¢—ç å­å ä½å®½åº¦ï¼ˆpxï¼‰
let BEAD = 20;   // ç å­ç›´å¾„ï¼ˆpxï¼‰
let ROW_W = 0;   // è¡Œæ€»å®½ï¼ˆpxï¼‰

/* ---- å¸ƒå±€è®¡ç®— ---- */
function calcLayout() {
    // 22 æ ¼ = å·¦ 10 + ä¸­é—´ 2 æ ¼ç©ºéš™ + å³ 10
    var maxW = Math.min(window.innerWidth - 60, 560);
    SLOT = Math.max(16, Math.floor(maxW / 22));
    BEAD = Math.max(13, SLOT - 4);
    ROW_W = SLOT * 22;
}

/* ---- æ„å»ºç®—ç›˜ DOM ---- */
function buildAbacus() {
    calcLayout();
    var wrap = document.getElementById('abacus');
    wrap.innerHTML = '';
    for (var r = 0; r < ROWS; r++) {
        // åˆ†éš”çº¿ï¼ˆé»˜è®¤éšè—ï¼Œæ¼”ç¤ºæ—¶æŒ‰éœ€æ˜¾ç¤ºï¼‰
        if (r > 0) {
            var divider = document.createElement('div');
            divider.className = 'abacus-divider';
            divider.id = 'divider-' + r;
            wrap.appendChild(divider);
        }
        var rowEl = document.createElement('div');
        rowEl.className = 'abacus-row';
        rowEl.dataset.row = String(r);
        rowEl.style.width = ROW_W + 'px';

        var rod = document.createElement('div');
        rod.className = 'rod';
        rowEl.appendChild(rod);

        for (var c = 0; c < COLS; c++) {
            var bead = document.createElement('div');
            bead.className = 'bead ' + ROW_COLORS[r];
            bead.dataset.row = String(r);
            bead.dataset.col = String(c);
            bead.style.width = BEAD + 'px';
            bead.style.height = BEAD + 'px';
            rowEl.appendChild(bead);
        }
        wrap.appendChild(rowEl);
    }
    resetAbacus();
}

/* ---- æ¸²æŸ“å•è¡Œç å­ä½ç½® ---- */
function renderRow(r) {
    var on = rowStates[r];
    var rowEl = document.querySelector('.abacus-row[data-row="' + r + '"]');
    if (!rowEl) return;
    var beads = rowEl.querySelectorAll('.bead');
    beads.forEach(function(b) {
        var c = parseInt(b.dataset.col);
        var left;
        if (c < (10 - on)) {
            // ç•™åœ¨å·¦è¾¹
            left = c * SLOT;
        } else {
            // æ‹¨åˆ°å³è¾¹ï¼ˆé å³å¯¹é½ï¼‰
            left = (12 + c) * SLOT;
        }
        b.style.left = left + 'px';
    });
}

/* ---- é‡ç½®ç®—ç›˜ ---- */
function resetAbacus() {
    rowStates = new Array(ROWS).fill(0);
    for (var r = 0; r < ROWS; r++) renderRow(r);
    // éšè—æ‰€æœ‰åˆ†éš”çº¿
    for (var i = 1; i < ROWS; i++) {
        var d = document.getElementById('divider-' + i);
        if (d) d.classList.remove('visible');
    }
}

/* ---- æ‹¨ç éŸ³æ•ˆ ---- */
var audioCtx = null;
function playTick() {
    try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        var o = audioCtx.createOscillator();
        var g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = 800; o.type = 'sine';
        g.gain.setValueAtTime(0.08, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
        o.start(audioCtx.currentTime);
        o.stop(audioCtx.currentTime + 0.03);
    } catch(e) {}
}

/* ---- è¯­éŸ³æœ—è¯»ï¼ˆè¾¹æ‹¨è¾¹è¯»ï¼‰ ---- */
function speakAndWait(text, minMs) {
    var plain = (text || '').replace(/<[^>]+>/g, '').trim();
    minMs = minMs || 1200;
    return new Promise(function(resolve) {
        if (!window.speechSynthesis || !plain) {
            setTimeout(resolve, minMs);
            return;
        }
        try {
            var u = new SpeechSynthesisUtterance(plain);
            u.lang = 'zh-CN';
            u.rate = 1.0;
            u.pitch = 1.15;
            u.volume = 1.0;
            // ä¼˜å…ˆé€‰è‡ªç„¶çš„å¥³å£°ï¼ˆXiaoxiao / Yaoyao / Huihui ç­‰å¾®è½¯ä¸­æ–‡è¯­éŸ³æ›´è‡ªç„¶ï¼‰
            var vs = speechSynthesis.getVoices();
            var pick = null;
            // ä¼˜å…ˆçº§ï¼šMicrosoft åœ¨çº¿ç¥ç»è¯­éŸ³ > Google ä¸­æ–‡ > ä»»ä½•ä¸­æ–‡
            var prefer = ['xiaoxiao', 'yaoyao', 'yunxi', 'xiaoyi', 'huihui', 'kangkang', 'google'];
            for (var p = 0; p < prefer.length && !pick; p++) {
                pick = vs.find(function(v) {
                    return v.lang.indexOf('zh') >= 0 && v.name.toLowerCase().indexOf(prefer[p]) >= 0;
                });
            }
            if (!pick) pick = vs.find(function(v) { return v.lang.indexOf('zh') >= 0; });
            if (pick) u.voice = pick;
            var done = false;
            function finish() { if (!done) { done = true; resolve(); } }
            u.onend = finish;
            u.onerror = finish;
            // å®‰å…¨è¶…æ—¶ï¼šé˜²æ­¢ onend ä¸è§¦å‘
            setTimeout(finish, Math.max(minMs, plain.length * 280 + 800));
            speechSynthesis.speak(u);
        } catch(e) {
            setTimeout(resolve, minMs);
        }
    });
}

/* ---- æ˜¾ç¤º + æœ—è¯»ï¼ˆè¾¹æ˜¾ç¤ºæ–‡å­—è¾¹è¯»å‡ºæ¥ï¼‰ ---- */
function sayAndSpeak(html, minMs) {
    var el = document.getElementById('explain');
    var line = document.createElement('div');
    line.className = 'line';
    line.innerHTML = html;
    el.appendChild(line);
    el.scrollTop = el.scrollHeight;
    return speakAndWait(html, minMs);
}

function clearSay() {
    if (window.speechSynthesis) speechSynthesis.cancel();
    document.getElementById('explain').innerHTML = '';
}

function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

/* ---- åŠ¨ç”»ï¼šå¾€å³æ‹¨ count é¢—ç å­ï¼Œä» startRow è¡Œå¼€å§‹ ---- */
/* æ•´åï¼ˆæ»¡è¡Œï¼‰å¿«é€Ÿåˆ·è¿‡å»ï¼Œé›¶å¤´æ…¢æ…¢æ‹¨ */
async function animatePushRight(startRow, count, slowDelay) {
    slowDelay = slowDelay || 200;
    var fastDelay = 30;   // æ•´è¡Œå¿«é€Ÿæ‹¨
    var remaining = count;
    var row = startRow;
    while (remaining > 0 && row < ROWS) {
        var canPush = COLS - rowStates[row];
        var toPush = Math.min(canPush, remaining);
        // å¦‚æœè¦æŠŠæ•´è¡Œ 10 é¢—å…¨æ¨æ»¡ï¼Œç”¨å¿«é€Ÿæ¨¡å¼
        var isFullRow = (toPush === 10 && rowStates[row] === 0);
        var d = isFullRow ? fastDelay : slowDelay;
        for (var i = 0; i < toPush; i++) {
            rowStates[row]++;
            renderRow(row);
            var movedCol = COLS - rowStates[row];
            var bead = document.querySelector('.bead[data-row="' + row + '"][data-col="' + movedCol + '"]');
            if (bead) {
                bead.classList.add('flash');
                setTimeout(function(b) { b.classList.remove('flash'); }, 300, bead);
            }
            playTick();
            await sleep(d);
        }
        remaining -= toPush;
        row++;
    }
}

/* ---- åŠ¨ç”»ï¼šå¾€å·¦æ‹¨å› count é¢—ç å­ï¼ˆä»æœ€åæœ‰ç å­çš„è¡Œå¼€å§‹å¾€å›æ‹¨ï¼‰ ---- */
async function animatePushBack(count, slowDelay) {
    slowDelay = slowDelay || 200;
    var fastDelay = 30;
    var remaining = count;
    for (var row = ROWS - 1; row >= 0 && remaining > 0; row--) {
        var current = rowStates[row];
        if (current === 0) continue;
        var toReturn = Math.min(current, remaining);
        // å¦‚æœè¦æŠŠæ•´è¡Œ 10 é¢—å…¨æ‹¨å›ï¼Œå¿«é€Ÿæ¨¡å¼
        var isFullRow = (toReturn === 10 && current === 10);
        var d = isFullRow ? fastDelay : slowDelay;
        for (var i = 0; i < toReturn; i++) {
            var movedCol = COLS - rowStates[row];
            rowStates[row]--;
            renderRow(row);
            var bead = document.querySelector('.bead[data-row="' + row + '"][data-col="' + movedCol + '"]');
            if (bead) {
                bead.classList.add('flash');
                setTimeout(function(b) { b.classList.remove('flash'); }, 300, bead);
            }
            playTick();
            await sleep(d);
        }
        remaining -= toReturn;
    }
}

/* ---- è§£æç®—å¼ ---- */
function parseExpr(str) {
    str = (str || '').trim().replace(/\s+/g, '').replace(/ï¼‹/g, '+').replace(/ï¼/g, '-');
    var m = str.match(/^(\d+)([+\-])(\d+)$/);
    if (!m) return null;
    return { a: parseInt(m[1]), op: m[2], b: parseInt(m[3]) };
}

function tensOnes(n) {
    n = Math.max(0, Math.min(99, n));
    return { t: Math.floor(n / 10), o: n % 10 };
}

/* ---- ä¸»æ¼”ç¤ºé€»è¾‘ ---- */
async function runDemo() {
    var input = document.getElementById('expr').value;
    var parsed = parseExpr(input);
    var goBtn = document.getElementById('go');

    if (!parsed) {
        clearSay();
        sayAndSpeak('è¯·è¾“å…¥ 100 ä»¥å†…çš„åŠ å‡ç®—å¼ï¼Œä¾‹å¦‚ <span class="hl">24+14</span> æˆ– <span class="hl">50-17</span>');
        return;
    }
    var a = parsed.a, b = parsed.b, op = parsed.op;
    if (a < 0 || a > 99 || b < 0 || b > 99) {
        clearSay(); sayAndSpeak('è¯·ä½¿ç”¨ 0 åˆ° 99 ä¹‹é—´çš„æ•°å“¦ã€‚'); return;
    }
    if (op === '+' && a + b > 99) {
        clearSay(); sayAndSpeak('ä¸¤ä¸ªæ•°åŠ èµ·æ¥è¶…è¿‡ 99 äº†ï¼Œç®—ç›˜æ”¾ä¸ä¸‹å“¦ã€‚'); return;
    }
    if (op === '-' && a < b) {
        clearSay(); sayAndSpeak('è¢«å‡æ•°æ¯”å‡æ•°å°ï¼Œç®—ç›˜æ²¡æ³•å‡åˆ°è´Ÿæ•°å“¦ã€‚'); return;
    }

    goBtn.disabled = true;
    clearSay();
    resetAbacus();
    await sleep(300);

    if (op === '+') {
        var tensA = Math.floor(a / 10), onesA = a % 10;
        var tensB = Math.floor(b / 10), onesB = b % 10;
        var rowsA = a === 0 ? 0 : Math.ceil(a / 10);   // A å å‡ è¡Œ
        var rowsB = b === 0 ? 0 : Math.ceil(b / 10);   // B å å‡ è¡Œ
        var canSeparate = (rowsA + rowsB <= ROWS);      // è¡Œæ•°å¤Ÿä¸å¤Ÿå®Œå…¨åˆ†å¼€

        if (canSeparate) {
            // ===== è¡Œæ•°å¤Ÿï¼šä¸¤ä¸ªæ•°å®Œå…¨åˆ†å¼€æ‹¨ =====
            // æ˜¾ç¤ºåˆ†éš”çº¿
            if (rowsA > 0 && rowsA < ROWS) {
                var div = document.getElementById('divider-' + rowsA);
                if (div) div.classList.add('visible');
            }
            // ç¬¬ä¸€ä¸ªæ•°
            await Promise.all([
                sayAndSpeak('å…ˆæ‹¨å‡ºç¬¬ä¸€ä¸ªæ•° <span class="hl">' + a + '</span>', 1500),
                animatePushRight(0, a, 200)
            ]);
            await sayAndSpeak(a + ' é‡Œé¢æœ‰<span class="hl">å‡ ä¸ªå</span>ï¼Œ<span class="hl">å‡ ä¸ªä¸€</span>å‘¢ï¼Ÿ', 2200);
            await sleep(800);
            // ç¬¬äºŒä¸ªæ•°ï¼šä» rowsA è¡Œå¼€å§‹ï¼ˆå®Œå…¨åˆ†å¼€ï¼‰
            await Promise.all([
                sayAndSpeak('å†æ‹¨å‡ºç¬¬äºŒä¸ªæ•° <span class="hl">' + b + '</span>', 1500),
                animatePushRight(rowsA, b, 200)
            ]);
            await sayAndSpeak(b + ' é‡Œé¢æœ‰<span class="hl">å‡ ä¸ªå</span>ï¼Œ<span class="hl">å‡ ä¸ªä¸€</span>å‘¢ï¼Ÿ', 2200);
            await sleep(800);
        } else {
            // ===== è¡Œæ•°ä¸å¤Ÿï¼šåä½åˆ†å¼€æ‹¨ï¼Œä¸ªä½åˆåœ¨ä¸€èµ· =====
            // A çš„ä¸ªä½è¡Œ = tensAï¼ˆç¬¬ tensA è¡Œæ”¾ A çš„ä¸ªä½ï¼‰
            // B çš„åä½ä» tensA + 1 è¡Œå¼€å§‹
            // B çš„ä¸ªä½ä¹Ÿæ”¾åˆ°ç¬¬ tensA è¡Œï¼ˆå’Œ A çš„ä¸ªä½åˆåœ¨ä¸€èµ·ï¼‰
            var onesRow = tensA;  // A çš„ä¸ªä½æ‰€åœ¨è¡Œ
            var bTensStart = tensA + (onesA > 0 ? 1 : 0);  // B çš„åä½èµ·å§‹è¡Œ

            // æ˜¾ç¤ºåˆ†éš”çº¿ï¼ˆA çš„éƒ¨åˆ†å’Œ B çš„åä½ä¹‹é—´ï¼‰
            if (bTensStart > 0 && bTensStart < ROWS) {
                var div = document.getElementById('divider-' + bTensStart);
                if (div) div.classList.add('visible');
            }

            // ç¬¬ä¸€ä¸ªæ•°
            await Promise.all([
                sayAndSpeak('å…ˆæ‹¨å‡ºç¬¬ä¸€ä¸ªæ•° <span class="hl">' + a + '</span>', 1500),
                animatePushRight(0, a, 200)
            ]);
            await sayAndSpeak(a + ' é‡Œé¢æœ‰<span class="hl">å‡ ä¸ªå</span>ï¼Œ<span class="hl">å‡ ä¸ªä¸€</span>å‘¢ï¼Ÿ', 2200);
            await sleep(800);

            // ç¬¬äºŒä¸ªæ•°ï¼šä¸€å¥è¯è¯´å®Œï¼Œåä½æ‹¨åˆ†å¼€çš„è¡Œï¼Œä¸ªä½åˆåœ¨ A çš„ä¸ªä½è¡Œ
            var bAnimPromise = (async function() {
                if (tensB > 0) await animatePushRight(bTensStart, tensB * 10, 200);
                if (onesB > 0) await animatePushRight(onesRow, onesB, 200);
            })();
            await Promise.all([
                sayAndSpeak('å†æ‹¨ç¬¬äºŒä¸ªæ•° <span class="hl">' + b + '</span>', 1500),
                bAnimPromise
            ]);
            await sayAndSpeak(b + ' é‡Œé¢æœ‰<span class="hl">å‡ ä¸ªå</span>ï¼Œ<span class="hl">å‡ ä¸ªä¸€</span>å‘¢ï¼Ÿ', 2200);
            await sleep(800);
        }

        // æœ€åæé—®
        await sayAndSpeak('ç°åœ¨ç®—ç›˜ä¸Šä¸€å…±æœ‰<span class="hl">å‡ ä¸ªå</span>ï¼Œ<span class="hl">å‡ ä¸ªä¸€</span>å‘¢ï¼Ÿæ•°ä¸€æ•°å§ï¼', 3000);
        await sleep(800);
        await sayAndSpeak('æ‰€ä»¥ï¼Œ<span class="hl">' + a + ' + ' + b + '</span> ç­‰äºå¤šå°‘å‘¢ï¼Ÿ', 2500);

    } else {
        // å‡æ³•
        var a0 = tensOnes(a);

        // æ‹¨å‡ºè¢«å‡æ•°
        await Promise.all([
            sayAndSpeak('å…ˆæ‹¨å‡º <span class="hl">' + a + '</span>', 1500),
            animatePushRight(0, a, 200)
        ]);
        await sayAndSpeak(a + ' é‡Œé¢æœ‰<span class="hl">å‡ ä¸ªå</span>ï¼Œ<span class="hl">å‡ ä¸ªä¸€</span>å‘¢ï¼Ÿ', 2200);
        await sleep(800);

        // æ‹¨å›å‡æ•°
        await Promise.all([
            sayAndSpeak('å‡å» <span class="hl">' + b + '</span>ï¼Œæ‹¨å› ' + b + ' é¢—ç å­', 1500),
            animatePushBack(b, 180)
        ]);
        await sleep(600);

        // æœ€åæé—®
        await sayAndSpeak('ç°åœ¨ç®—ç›˜ä¸Šè¿˜å‰©<span class="hl">å‡ ä¸ªå</span>ï¼Œ<span class="hl">å‡ ä¸ªä¸€</span>å‘¢ï¼Ÿæ•°ä¸€æ•°å§ï¼', 3000);
        await sleep(800);
        await sayAndSpeak('æ‰€ä»¥ï¼Œ<span class="hl">' + a + ' - ' + b + '</span> ç­‰äºå¤šå°‘å‘¢ï¼Ÿ', 2500);
    }

    goBtn.disabled = false;
}

/* ---- åˆå§‹åŒ– ---- */
// é¢„åŠ è½½è¯­éŸ³
if (window.speechSynthesis) {
    speechSynthesis.getVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = function() { speechSynthesis.getVoices(); };
    }
}

buildAbacus();
window.addEventListener('resize', function() {
    calcLayout();
    var rows = document.querySelectorAll('.abacus-row');
    rows.forEach(function(rowEl) {
        rowEl.style.width = ROW_W + 'px';
        var beads = rowEl.querySelectorAll('.bead');
        beads.forEach(function(b) { b.style.width = BEAD + 'px'; b.style.height = BEAD + 'px'; });
    });
    for (var r = 0; r < ROWS; r++) renderRow(r);
});

document.getElementById('go').addEventListener('click', runDemo);

// ====== åº”ç”¨å†…é”®ç›˜é€»è¾‘ ======
var exprValue = '';
function updateDisplay() {
    var box = document.getElementById('display');
    box.textContent = exprValue || ' ';
    document.getElementById('expr').value = exprValue;
}
updateDisplay();

document.getElementById('numpad').addEventListener('click', function(e) {
    var btn = e.target.closest('.nk');
    if (!btn) return;
    var val = btn.dataset.val;
    if (val === 'clear') {
        exprValue = '';
    } else if (val === 'del') {
        exprValue = exprValue.slice(0, -1);
    } else if (val === '+' || val === '-') {
        // åªå…è®¸ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œä¸”ä¸èƒ½åœ¨å¼€å¤´
        if (exprValue.length > 0 && !/[+\-]/.test(exprValue)) {
            exprValue += val;
        }
    } else {
        // æ•°å­—ï¼šé™åˆ¶æ¯ä¸ªæ•°æœ€å¤š 2 ä½
        var parts = exprValue.split(/([+\-])/);
        var lastPart = parts[parts.length - 1];
        if (lastPart.length < 2) {
            exprValue += val;
        }
    }
    updateDisplay();
});

// é˜»æ­¢ input å¼¹å‡ºç³»ç»Ÿé”®ç›˜
document.getElementById('expr').addEventListener('focus', function(e) {
    e.target.blur();
});
</script>
</body>
</html>
